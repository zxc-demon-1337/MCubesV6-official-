{% extends 'base.html' %}

{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'account/css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="content">
      <p class="title">{{ user.nickname }}</p>
      <div class="profile-wrapper">
        <div class="profile-card">
          <div class="info-section">
            <div class="input-group">
              <div class="input-row">
                <span class="label">Nickname</span>
                {% csrf_token %}
                <span class="value-span">{{ user.nickname }}</span>
                <button class="change-btn">Change</button>
              </div>
              <div class="input-row">
                <span class="label">E-mail</span>
                <span class="value-span">{{ user.email }}</span>
                <button class="change-btn">Change</button>
              </div>
              <div class="input-row">
                <span class="label">Password</span>
                <span class="value-span">****************</span>
                <button class="change-btn">Change</button>
              </div>
              <div class="input-row">
                <span class="label">Avatar</span>
                <span class="value-span"></span>
                <button class="change-btn">Change</button>
              </div>
                <form method="post" action="{% url 'account:logout' %}">
                {% csrf_token %}
                <button type="submit" class="sign-out-btn">Sign Out</button>
                </form>
            </div>
          </div>
          <span><img class="avatar" src="{{ user.avatar.url }}" alt="Avatar" /></span>
        </div>
      </div>
    </div>
</div>

<script>
document.querySelectorAll('.change-btn').forEach(button => {
    button.addEventListener('click', function() {
        const row = this.closest('.input-row');
        const valueEl = row.querySelector('.value-span');
        const field = row.querySelector('.label').textContent.toLowerCase();

        if (!valueEl) {
            console.error("valueEl –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å—Ç—Ä–æ–∫–µ:", row);
            return;
        }

        if (this.textContent === 'Change') {
            switchToEdit(field, valueEl, this);
        } else {
            switchToView(field, valueEl, this);
        }
    });
});

function switchToEdit(field, valueEl, button) {
    if (!valueEl) {
        console.error("valueEl is null");
        return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    const currentValue = valueEl.textContent?.trim() || '';
    button._originalValue = currentValue;
    button._valueEl = valueEl;

    let inputHtml;

    if (field === 'password') {
        valueEl.innerHTML = '';
        inputHtml = '<input type="password" value="" class="edit-input">';
    } else if (field === 'avatar') {
        inputHtml = `
            <div class="custom-file-upload">
                <input type="file" accept="image/*" class="edit-input" style="display: none;">
                <button type="button" class="custom-file-button">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</button>
                <span class="custom-file-text">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
            </div>
        `;
    } else {
        inputHtml = `<input type="text" value="${currentValue}" class="edit-input">`;
    }

    // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º HTML
    valueEl.innerHTML = inputHtml;

    // –¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    if (field === 'avatar') {
        const fileInput = valueEl.querySelector('.edit-input');
        const fileButton = valueEl.querySelector('.custom-file-button');
        const fileText = valueEl.querySelector('.custom-file-text');
        
        if (fileButton && fileInput) {
            fileButton.addEventListener('click', function() {
                fileInput.click();
            });
        }
        
        if (fileInput && fileText) {
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileText.textContent = this.files[0].name;
                } else {
                    fileText.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                }
            });
        }
    }
    
    button.textContent = 'Cancel';
    button.insertAdjacentHTML('afterend', ' <button class="save-btn" data-field="' + field + '">Save</button>');
}
function switchToView(field, valueEl, button) {
    const row = button.closest('.input-row');
    const saveBtn = row.querySelector('.save-btn');
    if (saveBtn) saveBtn.remove();

    // üîÅ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º span —Å **–∏—Å—Ö–æ–¥–Ω—ã–º** –∑–Ω–∞—á–µ–Ω–∏–µ–º (–ø—Ä–∏ Cancel)
    const input = valueEl.querySelector('.edit-input');
    if (input) {
        // üî• –ë–µ—Ä—ë–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∞ –Ω–µ —Ç–æ, —á—Ç–æ –≤–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const originalValue = button._originalValue || '';
        
        // –î–ª—è –∞–≤–∞—Ç–∞—Ä–∞ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        if (field === 'avatar') {
            valueEl.innerHTML = '';
        } else {
            valueEl.innerHTML = `<span class="value-span">${originalValue}</span>`;
        }
        
        // ‚ùå –£–î–ê–õ–ò–¢–ï –≠–¢–û–¢ –ë–õ–û–ö - –û–ù –°–û–ó–î–ê–ï–¢ –ù–û–í–´–ô –≠–õ–ï–ú–ï–ù–¢ –í–´–ë–û–†–ê –§–ê–ô–õ–ê
        /* 
        if (input.type === 'file') {
            const newInput = document.createElement('input');
            newInput.type = 'file';
            newInput.accept = 'image/*';
            newInput.className = 'edit-input';
            valueEl.appendChild(newInput);
        }
        */
    }

    button.textContent = 'Change';
}
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('save-btn')) {
        const field = e.target.getAttribute('data-field');
        const row = e.target.closest('.input-row');
        const changeBtn = row.querySelector('.change-btn');
        const valueEl = changeBtn._valueEl; // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Å—Å—ã–ª–∫—É

        if (!valueEl) {
            console.error("valueEl –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .then()");
            return;
        }

        const input = valueEl.querySelector('.edit-input');
        const value = input.value;
        const file = input.type === 'file' ? input.files[0] : null;

        if (field === 'password' && value.length < 8) {
            alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤');
            return;
        }

        const formData = new FormData();
        formData.append('field', field);
        if (file) {
            formData.append('value', file);
        } else {
            formData.append('value', value);
        }
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch('/account/update_account/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
.then(data => {
    if (data.success) {
        if (field === 'avatar' && data.new_value) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∞–≤–∞—Ç–∞—Ä–∞
                document.querySelectorAll('.avatar, .user-avatar, .profile-avatar').forEach(img => {
                img.src = data.new_value;
            });
        } else {
            // –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π
            let displayValue = data.new_value;
            if (field === 'password') {
                displayValue = '****************';
            }
            
            if ('new_value' in data) {
                valueEl.innerHTML = `<span class="value-span">${displayValue}</span>`;
            }
        }
        
        // –í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        changeBtn.textContent = 'Change';
        e.target.remove();
        
        // üî• –í–ê–ñ–ù–û: –í—ã–∑—ã–≤–∞–µ–º switchToView –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        switchToView(field, valueEl, changeBtn);
    } else {
        alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');

        if (field === 'avatar') {
            valueEl.innerHTML = '';
        }
    }
})
        .catch(err => {
            console.error(err);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        });
    }
});
</script>

{% endblock %}

{% block extra_js %}
{% endblock %}
